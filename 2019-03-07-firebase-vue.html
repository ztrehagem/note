<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Firebase+Vue.js 覚書 | note.ztrehagem.dev</title>
    <meta name="description" content="ただのメモ。">
    <meta name="generator" content="VuePress 1.4.0">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <meta property="og:title" content="note.ztrehagem.dev">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://note.ztrehagem.dev/">
  <meta property="og:image" content="https://github.com/ztrehagem.png">
  <meta property="og:locale" content="ja_JP">
  <meta property="og:site_name" content="note.ztrehagem.dev">
  <meta property="og:description" content="ただのメモ。">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@ztrehagem">
  <meta name="theme-color" content="#3C3C3C">
  <meta name="msapplication-navbutton-color" content="#3C3C3C">
  <meta name="apple-mobile-web-app-status-bar-style" content="#3C3C3C">
    
    <link rel="preload" href="/assets/css/0.styles.59ba12ca.css" as="style"><link rel="preload" href="/assets/js/app.c66bfb45.js" as="script"><link rel="preload" href="/assets/js/2.89c2be18.js" as="script"><link rel="preload" href="/assets/js/9.1f2afaaa.js" as="script"><link rel="prefetch" href="/assets/js/10.adc7d775.js"><link rel="prefetch" href="/assets/js/11.ea11e62e.js"><link rel="prefetch" href="/assets/js/12.78cf05a8.js"><link rel="prefetch" href="/assets/js/3.54d189f4.js"><link rel="prefetch" href="/assets/js/4.5f60d4ea.js"><link rel="prefetch" href="/assets/js/5.004059c6.js"><link rel="prefetch" href="/assets/js/6.9017830a.js"><link rel="prefetch" href="/assets/js/7.e4dfc479.js"><link rel="prefetch" href="/assets/js/8.b928ee0f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.59ba12ca.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">note.ztrehagem.dev</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://ztrehagem.dev/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ztrehagem.dev
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://ztrehagem.dev/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ztrehagem.dev
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Firebase+Vue.js 覚書</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/2019-03-07-firebase-vue.html#まえがき" class="sidebar-link">まえがき</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/2019-03-07-firebase-vue.html#firebase" class="sidebar-link">Firebase</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/2019-03-07-firebase-vue.html#hosting" class="sidebar-link">Hosting</a></li><li class="sidebar-sub-header"><a href="/2019-03-07-firebase-vue.html#authentication" class="sidebar-link">Authentication</a></li><li class="sidebar-sub-header"><a href="/2019-03-07-firebase-vue.html#firestore" class="sidebar-link">Firestore</a></li><li class="sidebar-sub-header"><a href="/2019-03-07-firebase-vue.html#functions" class="sidebar-link">Functions</a></li></ul></li><li><a href="/2019-03-07-firebase-vue.html#vue" class="sidebar-link">Vue</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/2019-03-07-firebase-vue.html#build-serve-deploy" class="sidebar-link">Build, Serve, Deploy</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/2019-03-07-firebase-vue.html#蛇足" class="sidebar-link">蛇足</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/2019-03-07-firebase-vue.html#alias-vs-symlink" class="sidebar-link">alias vs symlink</a></li><li class="sidebar-sub-header"><a href="/2019-03-07-firebase-vue.html#vscode" class="sidebar-link">VSCode</a></li><li class="sidebar-sub-header"><a href="/2019-03-07-firebase-vue.html#type-safeなstore" class="sidebar-link">type safeなstore</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="firebase-vue-js-覚書"><a href="#firebase-vue-js-覚書" class="header-anchor">#</a> Firebase+Vue.js 覚書</h1> <h2 id="まえがき"><a href="#まえがき" class="header-anchor">#</a> まえがき</h2> <p>&quot;<a href="https://teikyou.com" target="_blank" rel="noopener noreferrer">テイキョウドットコム<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>&quot;の裏側のCMSをFirebaseで作った話．
しばらくフレームワークとしてNuxt.jsを使っていたものの，<code>lang=&quot;ts&quot;</code>にしようとしていろいろ躓いたりして面倒だったので，流行り（？）の<code>@vue/cli</code>に全部任せることにした．もうSSRはいいかな．</p> <p>でもクライアントもサーバ(Firebase Functions)もTypeScriptで書けたらいいじゃん．良いじゃん（断定）</p> <p>そのうちNuxt.js+TypeScriptちゃんと研究しよ．
Nuxt.jsすき．</p> <h2 id="firebase"><a href="#firebase" class="header-anchor">#</a> Firebase</h2> <p>まずfirebase-toolsで</p> <div class="language-console extra-class"><pre class="language-text"><code>~/ $ firebase init
</code></pre></div><p>今回はHosting, Functions, Firestore, Authenticationを使う</p> <p>ディレクトリ構造はこう</p> <div class="language- extra-class"><pre class="language-text"><code>~/
|- functions/   --- Functionsのコード
|  |- src/         --- .tsファイル群
|  |- lib/         --- コンパイル済み.jsファイル群
|  |- package.json
|     ...
|- src/         --- クライアント側のコード
|  |- common/
|  |- site_name/     --- vue cliで作るディレクトリ
|  |  |- package.json
|  |     ...
|  `- site_name_2/   --- vue cliで作るディレクトリ
|     |- package.json
|        ...
|- public/      --- クライアント側ビルド済みファイル
|  |- site_name/
|  `- site_name_2/
|- .firebaserc
|- firebase.json
|- package.json
   ...
</code></pre></div><h3 id="hosting"><a href="#hosting" class="header-anchor">#</a> Hosting</h3> <p>表側と裏側の2サイトを用意するので従量プランにアップグレード．
その上で&quot;<a href="https://firebase.google.com/docs/hosting/multisites?hl=ja" target="_blank" rel="noopener noreferrer">複数のサイトでプロジェクトのリソースを共有する<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>&quot;の通りに，Hostingサイトと<code>~/public/site_name</code>を関連付ける．
また，SPAの場合すべてのURLリクエストをindex.htmlに飛ばす必要がある．&quot;<a href="https://firebase.google.com/docs/hosting/url-redirects-rewrites?hl=ja" target="_blank" rel="noopener noreferrer">Hosting 動作をカスタマイズする<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>&quot;の&quot;リライト&quot;の項など参考に各target毎に設定を行う．
こんな感じ．</p> <ul><li>~/firebase.json<div class="language-json extra-class"><pre class="language-json"><code>  <span class="token property">&quot;hosting&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;target&quot;</span><span class="token operator">:</span> <span class="token string">&quot;target_name&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;public&quot;</span><span class="token operator">:</span> <span class="token string">&quot;public/site_name&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;rewrites&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token string">&quot;**&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;destination&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/index.html&quot;</span>
    <span class="token punctuation">}</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre></div></li></ul> <p>vue cliの項に続く．</p> <h3 id="authentication"><a href="#authentication" class="header-anchor">#</a> Authentication</h3> <p>方式はとりあえずメール+パスワード認証にした．あとでGoogleアカウントにしよ．
Firebase Consoleからユーザを作成（CMSを利用するのは限定人数なので）
実際に使えるメールアドレスと，仮の適当なパスワードで作る．
パスワード再設定用メール送信で実際のパスワードを設定させると同時にメール認証が完了する．</p> <h3 id="firestore"><a href="#firestore" class="header-anchor">#</a> Firestore</h3> <p>Firebase Consoleから作成しておく．ロックモードでよい．
Firestoreのreadは全員許可，writeを前項で作ったユーザのみに限定する．
ルールを以下のようにする．uidはユーザを作った時に発行されるやつ．
複数許可したり，emailで絞ることもできる．詳しくはドキュメント参照されたし．</p> <ul><li>~/firestore.rules<div class="language- extra-class"><pre class="language-text"><code>...
allow read;
allow write:
  if request.auth.token.email_verified
  &amp;&amp; request.auth.uid in [
    'XXXXXXXXXXXXXXXXXXXXXXXXXXXX',
    'YYYYYYYYYYYYYYYYYYYYYYYYYYYY'
  ];
...
</code></pre></div></li></ul> <p>複数fieldを使ったソートのクエリを使う必要があったので，indexを作成しておく．</p> <h3 id="functions"><a href="#functions" class="header-anchor">#</a> Functions</h3> <p>functionいっぱい作ってREST APIみたいにするとそれぞれのfunctionの起動に時間がかかるっぽいので、1つのfunctionにexpressを載せる構成にした。
expressのようなFunctionsだけの依存ライブラリは<code>~/functions/package.json</code>にインストールしよう．</p> <h2 id="vue"><a href="#vue" class="header-anchor">#</a> Vue</h2> <div class="language-console extra-class"><pre class="language-text"><code>~/src $ vue create site_name
</code></pre></div><p>TypeScriptを使う設定にした．その他お好み．
これをサイト数ぶん作る．</p> <p>pugを使う場合は追加で</p> <div class="language-console extra-class"><pre class="language-text"><code>~/src/site_name $ npm i -D pug pug-plain-loader
</code></pre></div><p>Firebase Consoleのoverviewにある&quot;<em>アプリにFirebaseを追加して利用を開始しましょう</em>&quot;から，initializaAppするために必要な値を確認し，<code>.env</code>を以下のように設定．
<code>.env</code>の仕様の詳細はドキュメント参照されたし</p> <ul><li><p>~/src/site_name/.env.production</p> <div class="language-text extra-class"><pre class="language-text"><code>VUE_APP_FIREBASE_FUNCTIONS_URL=https://region-name-project-id.cloudfunctions.net/

VUE_APP_FIREBASE_API_KEY=xxx
VUE_APP_FIREBASE_AUTH_DOMAIN=project-id.firebaseapp.com
VUE_APP_FIREBASE_DATABASE_URL=https://project-id.firebaseio.com
VUE_APP_FIREBASE_PROJECT_ID=project-id
VUE_APP_FIREBASE_STORAGE_BUCKET=project-id.appspot.com
VUE_APP_FIREBASE_MESSAGING_SENDER_ID=xxx
...
</code></pre></div></li> <li><p>~/src/site_name/.env.development</p> <div class="language-text extra-class"><pre class="language-text"><code>VUE_APP_FIREBASE_FUNCTIONS_URL=http://localhost:5001/project-id/us-central1/

おなじ
...
</code></pre></div></li></ul> <p><code>$ firebase serve</code>でローカルで動かすとき，Firestoreだけはローカルで立たないので，<code>.env.development</code>では予め用意したstaging用のFirebaseプロジェクトを使うようにすると◎．（その場合Firestoreだけ使うのでstaging用プロジェクトの料金プランアップグレードは不要）</p> <p><code>.env</code>で設定したもののうち<code>VUE_APP_</code>で始まるものは以下のようにクライアントサイドのコードで呼び出せるのでそうなっている．</p> <ul><li><code>process.env.VUE_APP_XXX</code></li> <li><code>&lt;%= VUE_APP_XXX %&gt;</code> (<code>~/src/site_name/public/index.html</code>など)</li></ul> <p>headのmetaでcanonical urlが欲しいときは<code>VUE_APP_PUBLIC_PATH</code>など設定しておくと◎．</p> <p>そして最後にこう</p> <ul><li><p>firebase.ts</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  apiKey<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_APP_FIREBASE_API_KEY</span><span class="token punctuation">,</span>
  authDomain<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_APP_FIREBASE_AUTH_DOMAIN</span><span class="token punctuation">,</span>
  databaseURL<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_APP_FIREBASE_DATABASE_URL</span><span class="token punctuation">,</span>
  projectId<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_APP_FIREBASE_PROJECT_ID</span><span class="token punctuation">,</span>
  storageBucket<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_APP_FIREBASE_STORAGE_BUCKET</span><span class="token punctuation">,</span>
  messagingSenderId<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_APP_FIREBASE_MESSAGING_SENDER_ID</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

firebase<span class="token punctuation">.</span><span class="token function">initializeApp</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>axios.ts</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  baseURL<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_APP_FIREBASE_FUNCTIONS_URL</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <h2 id="build-serve-deploy"><a href="#build-serve-deploy" class="header-anchor">#</a> Build, Serve, Deploy</h2> <p>npm scriptだけ列挙する</p> <ul><li><p>~/functions/package.json</p> <div class="language-json: extra-class"><pre class="language-text"><code>    &quot;build&quot;: &quot;tsc&quot;,
    &quot;watch&quot;: &quot;tsc -w&quot;,
</code></pre></div></li> <li><p>~/src/site_name/package.json</p> <div class="language-json: extra-class"><pre class="language-text"><code>    &quot;build&quot;: &quot;vue-cli-service build --dest=../../public/site_name --mode=development&quot;,
    &quot;watch&quot;: &quot;vue-cli-service build --dest=../../public/site_name --mode=development --watch&quot;,
    &quot;prod&quot;: &quot;vue-cli-service build --dest=../../public/site_name --mode=production&quot;,
</code></pre></div></li> <li><p>~/package.json</p> <div class="language-json: extra-class"><pre class="language-text"><code>    &quot;build&quot;: &quot;run-s build:*&quot;,
    &quot;build:functions&quot;: &quot;npm --prefix=functions run build&quot;,
    &quot;build:site_name&quot;: &quot;npm --prefix=src/site_name run build&quot;,
    &quot;build:site_name_2&quot;: &quot;npm --prefix=src/site_name_2 run build&quot;,
    &quot;serve&quot;: &quot;firebase serve --project project-id-staging&quot;,
    &quot;prod:site_name&quot;: &quot;npm --prefix=src/site_name run prod&quot;,
    &quot;prod:site_name_2&quot;: &quot;npm --prefix=src/site_name_2 run prod&quot;,
    &quot;predeploy&quot;: &quot;run-s clean prod:*&quot;,
    &quot;deploy&quot;: &quot;firebase deploy --project project-id&quot;,
    &quot;clean&quot;: &quot;rm -r public || true&quot;,
</code></pre></div></li></ul> <p>開発中は<code>npm run watch</code>を各package.jsonの位置で実行する．またはルートで<code>npm run build</code>．
その後ルートで<code>npm run serve</code>でFirebase Hostingがローカルで動く．
<code>npm run deploy</code>で全部productionビルドしてデプロイする．Functionsはfirebase-toolsが勝手にビルドします．
<code>npm run deploy -- --only functions</code>とかも可能．詳しくはfirebase-toolsのドキュメント参照されたし</p> <p><code>run-s</code>は<code>npm-run-all</code>パッケージ</p> <h2 id="蛇足"><a href="#蛇足" class="header-anchor">#</a> 蛇足</h2> <h3 id="alias-vs-symlink"><a href="#alias-vs-symlink" class="header-anchor">#</a> alias vs symlink</h3> <p>複数サイト間やVue・Functions間でinterfaceの定義を共有したかったりする．
tsconfig.jsonのpathsで<code>&quot;@common/*&quot;: [&quot;../../comon/*&quot;]</code>とするか，
シンボリックリンク<code>ln -s ../../common ./common</code>とするか，
どっちがいいんだろうか？</p> <p>どちらにせよ実体がtsconfig.jsonやtslint.json/eslint.jsonの外側ディレクトリにあるので，
lintはかからないしwatchしてくれない・・・？</p> <h3 id="vscode"><a href="#vscode" class="header-anchor">#</a> VSCode</h3> <p>プロジェクトルートから見てtsconfigが複数あるので，paths解決やインテリセンス等々を上手にやってくれない．
tsconfigの位置毎にVSCodeを複窓して書いてるけどめんどくさいぞ！
いい方法教えてください．</p> <h3 id="type-safeなstore"><a href="#type-safeなstore" class="header-anchor">#</a> type safeなstore</h3> <p>Vuex+TypeScript問題に足突っ込む</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/29/2020, 9:13:01 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.c66bfb45.js" defer></script><script src="/assets/js/2.89c2be18.js" defer></script><script src="/assets/js/9.1f2afaaa.js" defer></script>
  </body>
</html>
